<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart - KickVibe</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    .cart-item {
      display: grid;
      grid-template-columns: 120px 1fr auto auto;
      gap: var(--spacing-lg);
      align-items: center;
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, var(--gray-50), var(--white));
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      transition: var(--transition);
    }

    .cart-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary);
    }

    .cart-item-image {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .cart-item:hover .cart-item-image img {
      transform: scale(1.05);
    }

    .cart-item-info h3 {
      margin-bottom: var(--spacing-sm);
      font-size: 1.1rem;
      font-weight: 700;
    }

    .cart-item-details {
      display: flex;
      gap: var(--spacing-lg);
      font-size: 0.95rem;
      color: var(--gray-500);
      margin-top: var(--spacing-sm);
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      width: fit-content;
      background-color: var(--white);
    }

    .quantity-selector button {
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.2rem;
      transition: var(--transition);
      color: var(--dark);
    }

    .quantity-selector button:hover {
      background-color: var(--primary);
      color: var(--white);
    }

    .quantity-selector input {
      width: 50px;
      text-align: center;
      border: none;
      padding: 0;
      font-weight: 700;
      font-size: 1rem;
      background: none;
    }

    .summary-card {
      background: linear-gradient(135deg, var(--gray-50), var(--white));
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-2xl);
      padding: var(--spacing-2xl);
      position: sticky;
      top: 120px;
      height: fit-content;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--gray-200);
      font-weight: 600;
    }

    .summary-row.total {
      font-size: 1.3rem;
      font-weight: 800;
      border-bottom: none;
      margin-bottom: var(--spacing-xl);
      padding-bottom: 0;
      color: var(--primary);
    }

    .empty-cart-icon {
      font-size: 4rem;
      margin-bottom: var(--spacing-lg);
    }

    @media (max-width: 768px) {
      .cart-item {
        grid-template-columns: 100px 1fr;
        gap: var(--spacing-md);
      }

      .cart-item-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: var(--spacing-md);
      }

      .summary-card {
        position: static;
        margin-top: var(--spacing-xl);
      }
    }
  </style>
</head>
<body>
  <div id="notifications"></div>

  <!-- Header -->
  <header>
    <div class="container">
      <nav class="navbar">
        <a href="../index.html" class="logo">KickVibe</a>
        
        <ul class="nav-links">
          <li><a href="../index.html">Home</a></li>
          <li><a href="./shop.html">Shop</a></li>
        </ul>

        <div class="nav-actions">
          <button class="nav-icon" id="darkModeToggle" title="Dark Mode">Dark</button>
          <button class="nav-icon" id="cartBtn" style="position: relative;" title="Cart">Cart<span class="cart-count" id="cartCount" style="display: none;">0</span></button>
          <button class="nav-icon" id="wishlistBtn" title="Wishlist">‚ù§Ô∏è</button>
          <button class="nav-icon" id="userBtn" title="Account">Account</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Cart Content -->
  <div style="min-height: 80vh; padding: var(--spacing-2xl) var(--spacing-md);">
    <div class="container">
      <div style="margin-bottom: var(--spacing-2xl);">
        <h1 style="font-size: clamp(2rem, 5vw, 3rem); margin-bottom: var(--spacing-md); font-weight: 800;">Shopping Cart</h1>
        <p style="color: var(--gray-500); font-size: 1rem;">Review your items before checking out</p>
      </div>

      <!-- Empty Cart -->
      <div id="emptyCart" style="text-align: center; padding: var(--spacing-3xl) var(--spacing-md);">
        <div class="empty-cart-icon"></div>
        <h2 style="font-weight: 800; margin-bottom: var(--spacing-md); font-size: 1.5rem;">Your cart is empty</h2>
        <p style="margin-bottom: var(--spacing-lg); color: var(--gray-500); font-size: 1rem;">Add some fire sneakers to get started shopping!</p>
        <a href="./shop.html" class="btn btn-primary btn-large" style="font-weight: 800;">Start Shopping</a>
      </div>

      <!-- Cart With Items -->
      <div id="cartContent" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 380px; gap: var(--spacing-2xl);" class="cart-layout">
          
          <!-- Cart Items -->
          <div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-lg);">
              <h2 style="font-weight: 700; font-size: 1.3rem;">Order Items</h2>
              <span style="color: var(--gray-500); font-weight: 600;" id="itemCount">0 items</span>
            </div>
            <div id="cartItems">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Order Summary -->
          <div class="summary-card">
            <h3 style="margin-bottom: var(--spacing-lg); font-weight: 800; font-size: 1.2rem;">Order Summary</h3>
            
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="subtotal" style="font-weight: 700;">$0.00</span>
            </div>

            <div class="summary-row">
              <span>Shipping</span>
              <span id="shipping" style="font-weight: 700;">$0.00</span>
            </div>

            <div class="summary-row">
              <span>Tax (10%)</span>
              <span id="tax" style="font-weight: 700;">$0.00</span>
            </div>

            <div class="summary-row total">
              <span>Total:</span>
              <span id="total">$0.00</span>
            </div>

            <button class="btn btn-primary btn-large" style="width: 100%; margin-bottom: var(--spacing-md); font-weight: 800;" id="checkoutBtn">
              Proceed to Checkout
            </button>

            <button class="btn btn-outline btn-large" style="width: 100%; font-weight: 800;" id="continueShopping">
              Continue Shopping
            </button>

            <div style="margin-top: var(--spacing-lg); padding: var(--spacing-lg); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-lg); border: 1px solid var(--success);">
              <div style="display: flex; align-items: center; gap: var(--spacing-sm); color: var(--success); font-weight: 700; margin-bottom: var(--spacing-xs);">
                Free Shipping Over $100
              </div>
              <p style="font-size: 0.85rem; color: var(--gray-600); margin: 0;">You get free shipping on orders over $100!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-grid">
        <div class="footer-section">
          <h4>About KickVibe</h4>
          <p style="color: var(--gray-300); font-size: 0.9rem;">Premium sneakers for sneaker enthusiasts worldwide.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="../index.html">Home</a></li>
            <li><a href="./shop.html">Shop</a></li>
            <li><a href="./contact.html">Contact</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Customer Service</h4>
          <ul>
            <li><a href="./shop.html">Shipping Info</a></li>
            <li><a href="./shop.html">Returns</a></li>
            <li><a href="./shop.html">Size Guide</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 KickVibe. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/state.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Dark mode
    if (stateManager.isDarkMode()) {
      document.body.classList.add('dark-mode');
    }

    document.getElementById('darkModeToggle').addEventListener('click', () => {
      stateManager.toggleDarkMode();
      document.body.classList.toggle('dark-mode');
    });

    // Cart button
    document.getElementById('cartBtn').addEventListener('click', () => {
      // Already on cart page
      console.log('Already on cart page');
    });

    // User button
    document.getElementById('userBtn').addEventListener('click', () => {
      const user = stateManager.getUser();
      if (user) {
        window.location.href = './profile.html';
      } else {
        window.location.href = './login.html';
      }
    });

    document.getElementById('wishlistBtn').addEventListener('click', () => {
      window.location.href = './wishlist.html';
    });

    // Continue shopping
    document.getElementById('continueShopping').addEventListener('click', () => {
      window.location.href = './shop.html';
    });

    // Checkout button
    document.getElementById('checkoutBtn').addEventListener('click', () => {
      if (!isLoggedIn()) {
        stateManager.showNotification('Please login to checkout', 'warning');
        window.location.href = './login.html';
        return;
      }
      window.location.href = './checkout.html';
    });

    /**
     * Render cart
     */
    function renderCart() {
      try {
        const cart = stateManager.getCart();
        const emptyCart = document.getElementById('emptyCart');
        const cartContent = document.getElementById('cartContent');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');

        // Update cart count in navigation
        if (cart.length > 0) {
          cartCount.textContent = cart.length;
          cartCount.style.display = 'flex';
        } else {
          cartCount.style.display = 'none';
        }

        if (cart.length === 0) {
          emptyCart.style.display = 'block';
          cartContent.style.display = 'none';
          return;
        }

        emptyCart.style.display = 'none';
        cartContent.style.display = 'block';

        document.getElementById('itemCount').textContent = `${cart.length} item${cart.length !== 1 ? 's' : ''}`;

        cartItems.innerHTML = cart.map((item, index) => {
          // Ensure all required properties exist
          const name = item.name || 'Unknown Product';
          const price = item.price || 0;
          const size = item.size || 'N/A';
          const stock = item.stock || 0;
          const quantity = item.quantity || 1;
          
          return `
            <div class="cart-item">
              <div class="cart-item-image">
                <img src="${getProductImage(item)}" alt="${name}" onerror="this.src='https://via.placeholder.com/120?text=${encodeURIComponent(name)}'">
              </div>
              <div class="cart-item-info">
                <h3>${name}</h3>
                <div class="cart-item-details">
                  <span>Size: <strong>${size}</strong></span>
                  <span>Stock: <strong>${stock}</strong></span>
                </div>
                <div style="margin-top: var(--spacing-md); font-weight: 800; font-size: 1.2rem; color: var(--primary);">
                  ${formatPrice(price)}
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-md); align-items: flex-end;">
                <div class="quantity-selector">
                  <button onclick="updateQuantity(${index}, ${quantity - 1})">‚àí</button>
                  <input type="number" value="${quantity}" onchange="updateQuantity(${index}, this.value)" readonly>
                  <button onclick="updateQuantity(${index}, ${quantity + 1})">+</button>
                </div>
                <button class="btn btn-ghost" onclick="removeItem(${index})" style="color: var(--danger); font-weight: 700; padding: 0;">
                  üóëÔ∏è Remove
                </button>
              </div>
            </div>
          `;
        }).join('');

        updateSummary();
      } catch (error) {
        console.error('Error rendering cart:', error);
        showNotification('Error displaying cart: ' + error.message, 'error');
      }
    }

    /**
     * Update cart summary
     */
    function updateSummary() {
      try {
        const cart = stateManager.getCart();
        const subtotal = stateManager.getCartTotal();
        const shipping = cart.length > 0 ? (subtotal >= 100 ? 0 : 9.99) : 0;
        const tax = subtotal * 0.1;
        const total = subtotal + shipping + tax;

        document.getElementById('subtotal').textContent = formatPrice(subtotal);
        document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : formatPrice(shipping);
        document.getElementById('tax').textContent = formatPrice(tax);
        document.getElementById('total').textContent = formatPrice(total);
      } catch (error) {
        console.error('Error updating summary:', error);
      }
    }

    /**
     * Update item quantity
     */
    function updateQuantity(index, newQuantity) {
      try {
        const cart = stateManager.getCart();
        
        if (!cart[index]) {
          console.error('Cart item at index ' + index + ' not found');
          renderCart();
          return;
        }
        
        const quantity = parseInt(newQuantity);

        if (quantity < 1) {
          removeItem(index);
          return;
        }

        if (quantity > cart[index].stock) {
          stateManager.showNotification(`Only ${cart[index].stock} items in stock`, 'warning');
          return;
        }

        stateManager.updateCartQuantity(cart[index].cartItemId, quantity);
        renderCart();
      } catch (error) {
        console.error('Error updating quantity:', error);
        showNotification('Error updating quantity: ' + error.message, 'error');
      }
    }

    /**
     * Remove item from cart
     */
    function removeItem(index) {
      try {
        const cart = stateManager.getCart();
        
        if (!cart[index]) {
          console.error('Cart item at index ' + index + ' not found');
          renderCart();
          return;
        }
        
        const item = cart[index];
        stateManager.removeFromCart(item.cartItemId);
        stateManager.showNotification(`${item.name} removed from cart`, 'info');
        renderCart();
      } catch (error) {
        console.error('Error removing item:', error);
        showNotification('Error removing item: ' + error.message, 'error');
      }
    }

    /**
     * Initialize cart
     */
    function initCart() {
      try {
        // Ensure stateManager exists
        if (typeof stateManager === 'undefined') {
          console.error('StateManager not loaded');
          return;
        }

        // Debug log
        console.log('Initializing cart...');
        console.log('Cart items:', stateManager.getCart().length);
        
        // Initial render
        renderCart();
        
        // Subscribe to state changes
        stateManager.subscribe((state) => {
          console.log('State changed, re-rendering cart...');
          renderCart();
        });
      } catch (error) {
        console.error('Error initializing cart:', error);
        showNotification('Error initializing cart: ' + error.message, 'error');
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCart);
    } else {
      initCart();
    }
  </script>
  </script>
</body>
</html>
