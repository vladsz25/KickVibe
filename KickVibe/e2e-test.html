<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart End-to-End Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
    .test-step {
      margin: 15px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #3b82f6;
    }
    .test-step.success {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    .test-step.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    .data-display {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }
    pre {
      margin: 0;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üß™ KickVibe Cart End-to-End Test</h1>
  
  <div class="test-section">
    <h2>Test Scenario: Complete Cart Flow</h2>
    <p>This test will verify the complete cart workflow:</p>
    <ol>
      <li>Clear all data</li>
      <li>Check state manager initialization</li>
      <li>Verify products are loaded</li>
      <li>Add item to cart</li>
      <li>Verify localStorage</li>
      <li>Simulate page reload (cart persistence)</li>
      <li>Verify cart displays items</li>
      <li>Test cart operations (update, remove)</li>
    </ol>
  </div>

  <div class="test-section">
    <h2>Quick Actions</h2>
    <button onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
    <button onclick="runFullTest()">‚ñ∂Ô∏è Run Full Test</button>
    <button onclick="goToProduct()">‚û°Ô∏è Go to Product Page (ID: 1)</button>
    <button onclick="goToCart()">üõí Go to Cart Page</button>
  </div>

  <div class="test-section" id="results">
    <h2>Test Results</h2>
    <div id="testOutput"></div>
  </div>

  <script src="./js/state.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/auth.js"></script>

  <script>
    function log(message, type = 'info') {
      const output = document.getElementById('testOutput');
      const step = document.createElement('div');
      step.className = `test-step ${type}`;
      step.textContent = message;
      output.appendChild(step);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function logData(label, data) {
      const output = document.getElementById('testOutput');
      const step = document.createElement('div');
      step.className = 'test-step';
      step.innerHTML = `<strong>${label}:</strong><div class="data-display"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
      output.appendChild(step);
    }

    function clearAllData() {
      localStorage.clear();
      location.reload();
    }

    function goToProduct() {
      window.location.href = './pages/product.html?id=1';
    }

    function goToCart() {
      window.location.href = './pages/cart.html';
    }

    async function runFullTest() {
      document.getElementById('testOutput').innerHTML = '';
      
      try {
        // Test 1: Clear data
        log('‚úì Test 1: Clearing all data', 'success');
        localStorage.clear();
        
        // Test 2: Reload state manager
        log('‚úì Test 2: StateManager initialized', 'success');
        logData('StateManager Type', { type: typeof stateManager });
        
        // Test 3: Check products
        const products = stateManager.getProducts();
        log(`‚úì Test 3: Products loaded (${products.length} products)`, products.length > 0 ? 'success' : 'error');
        if (products.length === 0) {
          throw new Error('No products loaded');
        }
        
        // Test 4: Get first product
        const product = stateManager.getProductById(1);
        log(`‚úì Test 4: Found product: ${product.name}`, 'success');
        logData('Product Details', { 
          id: product.id, 
          name: product.name, 
          price: product.price,
          sizes: product.sizes
        });
        
        // Test 5: Check initial cart
        const cartBefore = stateManager.getCart();
        log(`‚úì Test 5: Initial cart: ${cartBefore.length} items`, 'success');
        
        // Test 6: Add item to cart
        const selectedSize = product.sizes[0];
        stateManager.addToCart(product, selectedSize, 1);
        log(`‚úì Test 6: Added item to cart (${product.name}, Size: ${selectedSize})`, 'success');
        
        // Test 7: Check cart after add
        const cartAfter = stateManager.getCart();
        log(`‚úì Test 7: Cart after add: ${cartAfter.length} items`, cartAfter.length > 0 ? 'success' : 'error');
        if (cartAfter.length === 0) {
          throw new Error('Cart is empty after adding item');
        }
        logData('Cart Items', cartAfter.map(item => ({
          name: item.name,
          size: item.size,
          quantity: item.quantity,
          price: item.price,
          cartItemId: item.cartItemId
        })));
        
        // Test 8: Check localStorage
        const savedCart = localStorage.getItem('kickvibe_cart');
        log(`‚úì Test 8: Cart saved to localStorage`, savedCart ? 'success' : 'error');
        logData('LocalStorage Cart', JSON.parse(savedCart || '[]'));
        
        // Test 9: Simulate page reload
        log(`‚úì Test 9: Simulating page reload...`, 'success');
        const cartData = localStorage.getItem('kickvibe_cart');
        const cartLoaded = JSON.parse(cartData || '[]');
        log(`‚úì Test 9b: Cart loaded from localStorage: ${cartLoaded.length} items`, cartLoaded.length > 0 ? 'success' : 'error');
        
        // Test 10: Get cart total
        const total = stateManager.getCartTotal();
        log(`‚úì Test 10: Cart total calculated: $${total.toFixed(2)}`, 'success');
        
        // Test 11: Update quantity
        const item = stateManager.getCart()[0];
        stateManager.updateCartQuantity(item.cartItemId, 3);
        const updatedTotal = stateManager.getCartTotal();
        log(`‚úì Test 11: Updated quantity to 3, new total: $${updatedTotal.toFixed(2)}`, 'success');
        
        // Test 12: Add another product
        const product2 = stateManager.getProductById(2);
        if (product2) {
          stateManager.addToCart(product2, product2.sizes[0], 1);
          const finalCart = stateManager.getCart();
          log(`‚úì Test 12: Added second product, cart now has ${finalCart.length} items`, 'success');
          logData('Final Cart', finalCart.map(item => ({
            name: item.name,
            size: item.size,
            quantity: item.quantity
          })));
        }
        
        // Final summary
        log('', 'success');
        log('‚úÖ ALL TESTS PASSED!', 'success');
        log('The cart system is working correctly. You should see items when you visit the cart page.', 'success');
        
        logData('Final Summary', {
          productsLoaded: stateManager.getProducts().length,
          itemsInCart: stateManager.getCart().length,
          cartTotal: `$${stateManager.getCartTotal().toFixed(2)}`,
          localStorageSaved: Boolean(localStorage.getItem('kickvibe_cart'))
        });

      } catch (error) {
        log(`‚ùå ERROR: ${error.message}`, 'error');
        console.error('Test failed:', error);
      }
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      log('Page loaded. Ready to run tests.', 'success');
      log('Click "Run Full Test" to verify the cart system.', 'info');
    });
  </script>
</body>
</html>
